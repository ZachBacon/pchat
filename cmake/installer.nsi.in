; PChat NSIS Installer Script
; This installer allows users to select which plugins to install

;--------------------------------
; Defines
!define SOURCE_DIR "@CMAKE_INSTALL_PREFIX@"

;--------------------------------
; Includes
!include "MUI2.nsh"
!include "Sections.nsh"
!include "LogicLib.nsh"

;--------------------------------
; General
Name "PChat @PROJECT_VERSION@"
OutFile "@CMAKE_SOURCE_DIR@/PChat-@PROJECT_VERSION@-win64.exe"
InstallDir "$PROGRAMFILES64\PChat"
InstallDirRegKey HKLM "Software\PChat" "Install_Dir"
RequestExecutionLevel admin

;--------------------------------
; Interface Settings
!define MUI_ABORTWARNING
!define MUI_ICON "@CMAKE_SOURCE_DIR@\src\fe-gtk3\pchat.ico"
!define MUI_UNICON "@CMAKE_SOURCE_DIR@\src\fe-gtk3\pchat.ico"

;--------------------------------
; Pages
!insertmacro MUI_PAGE_LICENSE "@CMAKE_SOURCE_DIR@\COPYING"
!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

;--------------------------------
; Languages
!insertmacro MUI_LANGUAGE "English"

;--------------------------------
; Sections

Section "PChat (required)" SecCore
  SectionIn RO
  
  SetOutPath "$INSTDIR\bin"
  File "@CMAKE_INSTALL_PREFIX@\bin\pchat.exe"
  File "@CMAKE_INSTALL_PREFIX@\bin\*.dll"
  
  SetOutPath "$INSTDIR\share"
  File /r "@CMAKE_INSTALL_PREFIX@\share\glib-2.0"
  File /r "@CMAKE_INSTALL_PREFIX@\share\icons"
  File /r "@CMAKE_INSTALL_PREFIX@\share\pchat"
  
  SetOutPath "$INSTDIR\lib"
  File /r "@CMAKE_INSTALL_PREFIX@\lib\gdk-pixbuf-2.0"
  
  ; Create directories
  CreateDirectory "$INSTDIR\lib\pchat\plugins"
  
  ; Write registry keys
  WriteRegStr HKLM "Software\PChat" "Install_Dir" "$INSTDIR"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "DisplayName" "PChat @PROJECT_VERSION@"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "UninstallString" '"$INSTDIR\uninstall.exe"'
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "DisplayIcon" "$INSTDIR\bin\pchat.exe"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "DisplayVersion" "@PROJECT_VERSION@"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "Publisher" "PChat"
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat" "NoRepair" 1
  
  ; Create uninstaller
  WriteUninstaller "$INSTDIR\uninstall.exe"
  
  ; Create shortcuts
  CreateDirectory "$SMPROGRAMS\PChat"
  CreateShortcut "$SMPROGRAMS\PChat\PChat.lnk" "$INSTDIR\bin\pchat.exe"
  CreateShortcut "$SMPROGRAMS\PChat\Uninstall.lnk" "$INSTDIR\uninstall.exe"
  CreateShortcut "$DESKTOP\PChat.lnk" "$INSTDIR\bin\pchat.exe"
SectionEnd

Section "Translations" SecTranslations
  SetOutPath "$INSTDIR\share\locale"
  File /r "@CMAKE_INSTALL_PREFIX@\share\locale\*.*"
SectionEnd

Section "AudioPlayer Plugin" SecPluginAudioPlayer
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\audioplayer.dll"
SectionEnd

Section "Checksum Plugin" SecPluginChecksum
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\checksum.dll"
SectionEnd

Section "Exec Plugin" SecPluginExec
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\pchatexec.dll"
SectionEnd

Section "FiSHLiM Plugin" SecPluginFiSHLiM
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\fishlim.dll"
SectionEnd

Section "Lua Plugin" SecPluginLua
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\lua.dll"
SectionEnd

Section "SysInfo Plugin" SecPluginSysInfo
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\sysinfo.dll"
SectionEnd

Section "Winamp Plugin" SecPluginWinamp
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\pchatwinamp.dll"
SectionEnd

Section "Update Checker Plugin" SecPluginUpdateChecker
  SetOutPath "$INSTDIR\lib\pchat\plugins"
  File "@CMAKE_INSTALL_PREFIX@\lib\pchat\plugins\pchatupd.dll"
SectionEnd

Section "Development Headers" SecHeaders
  SetOutPath "$INSTDIR\include\pchat"
  File "@CMAKE_INSTALL_PREFIX@\include\pchat\pchat-plugin.h"
  
  SetOutPath "$INSTDIR\lib\pkgconfig"
  File "@CMAKE_INSTALL_PREFIX@\lib\pkgconfig\pchat-plugin.pc"
SectionEnd

;--------------------------------
; Descriptions

!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
  !insertmacro MUI_DESCRIPTION_TEXT ${SecCore} "Core PChat application and required files"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecTranslations} "Language translation files"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginAudioPlayer} "Play audio files in channels (requires FFmpeg and FAudio)"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginChecksum} "Calculate checksums for DCC file transfers"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginExec} "Execute external commands"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginFiSHLiM} "FiSH encryption support"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginLua} "Lua scripting support"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginSysInfo} "Display system information"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginWinamp} "Winamp integration"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecPluginUpdateChecker} "Check for PChat updates"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecHeaders} "Header files and pkg-config for plugin development"
!insertmacro MUI_FUNCTION_DESCRIPTION_END

;--------------------------------
; Uninstaller

Section "Uninstall"
  ; Remove registry keys
  DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PChat"
  DeleteRegKey HKLM "Software\PChat"
  
  ; Remove files and directories
  Delete "$INSTDIR\bin\*.*"
  Delete "$INSTDIR\lib\pchat\plugins\*.*"
  Delete "$INSTDIR\uninstall.exe"
  
  RMDir /r "$INSTDIR\share"
  RMDir /r "$INSTDIR\lib"
  RMDir /r "$INSTDIR\include"
  RMDir "$INSTDIR\lib\pchat\plugins"
  RMDir "$INSTDIR\lib\pchat"
  RMDir "$INSTDIR\bin"
  RMDir "$INSTDIR"
  
  ; Remove shortcuts
  Delete "$SMPROGRAMS\PChat\*.*"
  RMDir "$SMPROGRAMS\PChat"
  Delete "$DESKTOP\PChat.lnk"
SectionEnd
